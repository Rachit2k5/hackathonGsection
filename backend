import { IncomingForm } from 'formidable';
import path from 'path';

export const config = {
  api: {
    bodyParser: false,
  },
};

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Only POST allowed' });

  const form = new IncomingForm({ keepExtensions: true });

  form.parse(req, (err, fields, files) => {
    if (err) return res.status(500).json({ error: 'Form parsing error' });

    if (!files.photo) return res.status(400).json({ error: 'No photo uploaded' });

    const photo = files.photo;
    const filename = (photo.originalFilename || photo.name).toLowerCase();

    // Mock AI detection logic based on filename
    let label = 'Unknown Issue';
    if (filename.includes('pothole')) label = 'Pothole';
    else if (filename.includes('trash')) label = 'Trash Overflow';
    else if (filename.includes('streetlight')) label = 'Streetlight Issue';

    // You can access voiceDescription and location from fields
    const voiceDescription = fields.voiceDescription || '';
    let location = {};
    try {
      location = JSON.parse(fields.location || '{}');
    } catch {}

    // Respond with issue and echoed info
    res.status(200).json({ issue: label, voiceDescription, location });
  });
}

